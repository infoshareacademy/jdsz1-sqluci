--JDSZ1SU-14
--skonczone
-- Jaki jest potencjał poszczególnych regionów?
--Ile pociągów jest opóźnionych / anulowanych i jaka jest całkowita wartość rekompensaty?


--jakie sa rodzaje statusow
select distinct przylot_status from o_trasy;
--dy opozniony
--cx anulowany
--ot na czas
--ey wczesniej
--ns brak info
--null brak info - uznajemy za anulowane

with moje_dane as(
select
CASE
WHEN przylot_status ='CX' then 'anulowane'
WHEN przylot_status = 'DY' then 'opoznione'
WHEN przylot_status is null then 'anulowane'
 else '0' end status,
 count(*) liczba_pociagow, sum(rekompensata) suma_rekompensat
from o_trasy
where czy_uprawniony=true
group by 1
)
select *, sum(liczba_pociagow) over(), (liczba_pociagow/sum(liczba_pociagow) over()) procent_pociagow
from moje_dane
where status in ('anulowane', 'opoznione')
UNION
select 'razem', sum(liczba_pociagow),sum(suma_rekompensat),null,null
from moje_dane
where status in ('anulowane', 'opoznione')
order by 2;







